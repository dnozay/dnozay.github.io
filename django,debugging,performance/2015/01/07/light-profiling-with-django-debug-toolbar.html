<!DOCTYPE html><html><head><meta charset="utf-8"><meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1"><title>Light profiling with django-debug-toolbar</title><meta name="viewport" content="width=device-width"><script src="/js/main.23ed95cc.js"></script><link rel="stylesheet" href="/css/main.0cc28f01.css"></head><body><!-- Static navbar --><div class="navbar navbar-default navbar-static-top" role="navigation"><div class="container"><div class="navbar-header"><button type="button" class="navbar-toggle collapsed" data-toggle="collapse" data-target=".navbar-collapse"><span class="sr-only">Toggle navigation</span> <i class="fa fa-bars"></i></button> <a class="navbar-brand" href="#">dnozay.github.io</a></div><div class="navbar-collapse collapse"><ul class="nav navbar-nav"><li><a href="/">Home</a></li><li><a href="/about.html">About</a></li><li><a href="/test.html">test page</a></li></ul></div><!--/.nav-collapse --></div></div><div class="container"><div class="page-header"><h1>Light profiling with django-debug-toolbar <small>07 Jan 2015 <a href="/django,debugging,performance/2015/01/07/light-profiling-with-django-debug-toolbar.html"><i class="fa fa-link"></i></a></small></h1></div><div class="post"><p>Was recently coding like a monkey until I started seeing some performance issues on my dashboard. Once loaded with real data, things start to slow down to a crawl. The dashboard gets its data from a few API endpoints powered with <a href="http://www.django-rest-framework.org/"><code>django-rest-framework</code></a>.</p><p>After enabling <a href="http://django-debug-toolbar.readthedocs.org/"><code>django-debug-toolbar</code></a> here is what I am looking at:</p><p><img src="/img/2015-01-08-1-rest-output.c76f102c.png" alt="Using django-debug-toolbar"></p><p><strong>Yes, 2000 milliseconds and 190-some queries</strong>. Deeply-nested serializers will do that to you… On a closer look, I see many very similar queries:</p><p><img src="/img/2015-01-08-2-so-many-queries.c532b367.png" alt="So many queries..."></p><p>I decide to drill down to one of the nested serializers (you have to start someplace, right?) since those queries are directly related. Seems like there is one query for each <code>ForeignKey</code>.</p><p><img src="/img/2015-01-08-3-nested-serializer.47c1b437.png" alt="Peek at nested serializer"></p><p>How to cut down the number of queries? Easy. Where possible you can use <a href="https://docs.djangoproject.com/en/dev/ref/models/querysets/#select-related"><code>select_related</code></a> or <a href="https://docs.djangoproject.com/en/dev/ref/models/querysets/#prefetch-related"><code>prefetch_related</code></a>. In my use case, <a href="https://docs.djangoproject.com/en/dev/ref/models/querysets/#prefetch-related"><code>prefetch_related</code></a> makes more sense since I have a nested serializer that could leverage having the whole related object.</p><p>You can see that the number of queries is reduced, and the presence of <code>WHERE</code> in the last query. However something else is eating up some of the time.</p><p><img src="/img/2015-01-08-4-using-prefetch_related.6d47741f.png" alt="Using prefetch_related"></p><p>What is eating up the query time is an inefficient query. I could have used the <code>EXPL.</code> (explain query) button, but I know exactly what is happening: my custom <code>GenericForeignKey</code> is based on fields that are not indexed properly.</p><p>Just need to add <code>db_index=True</code> and get the sql with <code>./manage.py sqlall</code>.</p><p><code>SQL CREATE INDEX `testruns_keyvalueitem_37ef4eb4` ON `testruns_keyvalueitem` (`content_type_id`);</code></p><p>Instant gratification:</p><p><img src="/img/2015-01-08-5-using-db_index.bf667fd5.png" alt="Using db_index"></p><p>That’s it for now.</p></div><div class="pagination"><ul class="pager"><li class="previous"><a href="/compiling/2014/11/19/faster-compiles.html"><i class="fa fa-arrow-left"></i> Previous</a></li><li class="next disabled"><a href="#">Next <i class="fa fa-arrow-right"></i></a></li></ul></div></div><div class="footer"><div class="container text-center"><p>The contents of this website are <i class="fa fa-copyright"></i>&nbsp;2014 <a href="mailto:damiennozay+blog@gmail.com">Damien Nozay</a> under the terms of the <a href="http://opensource.org/licenses/MIT">MIT&nbsp;License</a>.</p><div><p><i class="fa fa-cog fa-spin"></i> Made with love thanks to: <a href="http://fontawesome.io/">Font Awesome</a><span class="hide-xs">·</span> <a href="http://getbootstrap.com/">Bootstrap</a><span class="hide-xs">·</span> <a href="http://jekyllrb.com/">Jekyll</a><span class="hide-xs">·</span> <a href="http://yeoman.io/">Yeoman</a><span class="hide-xs">·</span> <a href="https://github.com">Github</a><span class="hide-xs">·</span> and others...</p>Documentation licensed under <a href="http://creativecommons.org/licenses/by/3.0/">CC BY 3.0</a></div></div></div><script src="/js/scripts.71991f74.js"></script></body></html>